name: E2E Tests

on:
  # Run on push to main branch
  push:
    branches:
      - main

  # Run on pull requests
  pull_request:
    branches:
      - main

  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        # Run tests in parallel shards for faster execution
        shard: [1, 2, 3]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (shard ${{ matrix.shard }}/3)
        env:
          TEST_BASE_URL: https://www.awesomerobots.xyz
          SKIP_FORM_SUBMISSION: true
        run: npm run test:e2e -- --shard=${{ matrix.shard }}/3

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: |
            tests/screenshots/
            test-results/
          retention-days: 7

      - name: Upload coverage reports
        if: matrix.shard == 1
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

  critical-path-tests:
    name: Critical Path Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run critical path tests
        env:
          TEST_BASE_URL: https://www.awesomerobots.xyz
          SKIP_FORM_SUBMISSION: true
        run: npm run test:critical

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: critical-path-screenshots
          path: tests/screenshots/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, critical-path-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.e2e-tests.result }}" = "failure" ] || [ "${{ needs.critical-path-tests.result }}" = "failure" ]; then
            echo "Tests failed. Please check the logs and screenshots."
            exit 1
          else
            echo "All tests passed successfully!"
          fi

      - name: Create GitHub Issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Weekly E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            The weekly E2E tests have failed. Please investigate and fix the issues.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Test Results:**
            - E2E Tests: ${{ needs.e2e-tests.result }}
            - Critical Path Tests: ${{ needs.critical-path-tests.result }}

            **Next Steps:**
            1. Review the test logs in the workflow run
            2. Check the uploaded screenshots for visual issues
            3. Fix any broken tests or update them if the UI has changed
            4. Ensure the website is functioning correctly

            **Labels:** e2e-tests, automated-test-failure
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['e2e-tests', 'automated-test-failure']
            });
