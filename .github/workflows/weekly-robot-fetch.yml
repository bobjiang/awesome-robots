name: Weekly Article Collection

on:
  schedule:
    - cron: '0 10 * * 5'  # Friday 10 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  collect-articles:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Collect articles (no API calls)
        run: npm run fetch-articles

      - name: Commit collected articles
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/collected-articles/
          if git diff --staged --quiet; then
            echo "No new articles to commit"
          else
            ARTICLE_FILE="data/collected-articles/$(date +%Y-%m-%d).json"
            ARTICLE_COUNT=$(jq '.total_count' "$ARTICLE_FILE")

            git commit -m "chore: Collect weekly robotics articles - $ARTICLE_COUNT items

            Run 'npm run fetch-articles' locally and ask Claude Code to process them.

            Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push
          fi

      - name: Create processing reminder issue
        run: |
          ARTICLE_FILE="data/collected-articles/$(date +%Y-%m-%d).json"
          if [ -f "$ARTICLE_FILE" ]; then
            ARTICLE_COUNT=$(jq '.total_count' "$ARTICLE_FILE")
            IEEE_COUNT=$(jq '.articles.ieee | length' "$ARTICLE_FILE")
            ROBOT_REPORT_COUNT=$(jq '.articles.robotreport | length' "$ARTICLE_FILE")
            ARXIV_COUNT=$(jq '.articles.arxiv | length' "$ARTICLE_FILE")
            WEEK_RANGE=$(jq -r '.week_range' "$ARTICLE_FILE")

            gh issue create \
              --title "ðŸ“° Process Weekly Articles - $WEEK_RANGE" \
              --label "robot-data,claude-code,review-needed" \
              --body "## ðŸ“° Weekly Article Collection Ready

**Week**: $WEEK_RANGE
**Total Articles**: $ARTICLE_COUNT

### Source Breakdown
- **IEEE TV**: $IEEE_COUNT articles
- **Robot Report**: $ROBOT_REPORT_COUNT articles
- **arXiv**: $ARXIV_COUNT papers

### ðŸ¤– Processing with Claude Code

Use Claude Code Pro to extract robot data from these articles:

\`\`\`bash
# Open the collected articles file
cat $ARTICLE_FILE | jq .

# Ask Claude Code to process them:
# \"Please analyze the articles in $ARTICLE_FILE and extract any humanoid or quadruped robot information.
#  Create discovered robots entries following the DiscoveredRobot schema,
#  deduplicate against src/data/robots.json, and save to data/discovered-robots/$(date +%Y-%m-%d).json\"
\`\`\`

### Next Steps
1. Run the Claude Code command above
2. Review the extracted robot data
3. Manually merge high-quality discoveries to \`src/data/robots.json\`
4. Close this issue when complete

---
*Generated by Weekly Article Collection automation*"
          else
            echo "No article file found, skipping issue creation"
          fi
