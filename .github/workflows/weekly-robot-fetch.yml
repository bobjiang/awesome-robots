name: Weekly Robot Discovery & Digest Automation

on:
  schedule:
    - cron: '0 10 * * 5'  # Friday 10 AM UTC
  workflow_dispatch:  # Allow manual trigger
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: string  

jobs:
  weekly-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Step 1: Collect articles (no API calls)
      - name: Collect articles from RSS/arXiv
        run: npm run fetch-articles

      # Step 2: Extract robots using Anthropic API
      - name: Extract robot data from articles
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npm run extract-robots

      # Step 3: Generate weekly digest
      - name: Generate Awesome Robots Digest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npm run generate-digest

      # Step 4: Update analytics dashboard
      - name: Update analytics dashboard
        run: npm run update-analytics

      # Step 5: Create feature branch for automation
      - name: Create automation branch
        id: create_branch
        run: |
          BRANCH_NAME="automation/weekly-digest-$(date +%Y-%m-%d)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"

      # Step 6: Commit all automation outputs
      - name: Commit automation results
        run: |
          git add data/collected-articles/
          git add data/discovered-robots/
          git add content/blog/
          git add data/analytics/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            DATE=$(date +%Y-%m-%d)
            ARTICLE_FILE="data/collected-articles/$DATE.json"
            DIGEST_FILE=$(find content/blog -name "*digest-issue-*.md" -type f -printf '%T@ %p\n' | sort -rn | head -1 | cut -d' ' -f2)

            ARTICLE_COUNT=$(jq -r '.total_count // 0' "$ARTICLE_FILE")
            DISCOVERED_COUNT=$(jq -r '.summary.total_discovered // 0' "data/discovered-robots/$DATE.json" 2>/dev/null || echo "0")

            git commit -m "feat: Weekly automation results for $(date +%b' '%d', '%Y)

            - Collected $ARTICLE_COUNT articles from robotics sources
            - Discovered $DISCOVERED_COUNT new robots
            - Generated Awesome Robots Digest
            - Updated analytics dashboard

            Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push -u origin "${{ steps.create_branch.outputs.branch_name }}"
            echo "has_changes=true" >> $GITHUB_ENV
          fi

      # Step 7: Create Pull Request for review
      - name: Create Pull Request
        if: env.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y-%m-%d)
          WEEK_RANGE=$(jq -r '.week_range // "this week"' "data/collected-articles/$DATE.json")
          ARTICLE_COUNT=$(jq -r '.total_count // 0' "data/collected-articles/$DATE.json")
          DISCOVERED_COUNT=$(jq -r '.summary.total_discovered // 0' "data/discovered-robots/$DATE.json" 2>/dev/null || echo "0")
          DIGEST_FILE=$(find content/blog -name "*digest-issue-*.md" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2)
          DIGEST_TITLE=$(if [ -f "$DIGEST_FILE" ]; then grep -m1 '^title:' "$DIGEST_FILE" | sed 's/title: "\(.*\)"/\1/'; else echo "Weekly Digest"; fi)

          # Create PR body from template
          cat > /tmp/pr-body.md <<'TEMPLATE'
## ðŸ“Š Weekly Automation Results

**Week**: WEEK_RANGE_PLACEHOLDER
**Generated**: GENERATED_DATE_PLACEHOLDER

### ðŸ“° Article Collection
- **Total Articles**: ARTICLE_COUNT_PLACEHOLDER from IEEE TV, Robot Report, arXiv

### ðŸ” Robot Discovery
- **New Robots Discovered**: DISCOVERED_COUNT_PLACEHOLDER
- **Quality Breakdown**: See `data/discovered-robots/DATE_PLACEHOLDER.json`

### ðŸ“ Content Generated
- **Digest**: DIGEST_TITLE_PLACEHOLDER
- **File**: `DIGEST_FILE_PLACEHOLDER`

### ðŸ“ˆ Analytics
- Dashboard updated with latest metrics
- Performance tracking data refreshed

---

### âœ… Review Checklist
- [ ] Review discovered robots for accuracy
- [ ] Verify digest content quality
- [ ] Check analytics data integrity
- [ ] Approve for publication

### ðŸš€ Next Steps
1. Review the digest blog post for editorial quality
2. Verify discovered robots against official sources
3. Merge this PR to publish the digest
4. Consider adding high-quality discoveries to main catalog

---
*Generated by Weekly Robot Discovery & Digest Automation*
TEMPLATE

          # Substitute placeholders with actual values
          sed -i "s/WEEK_RANGE_PLACEHOLDER/$WEEK_RANGE/g" /tmp/pr-body.md
          sed -i "s/GENERATED_DATE_PLACEHOLDER/$(date +'%B %d, %Y at %H:%M UTC')/g" /tmp/pr-body.md
          sed -i "s/ARTICLE_COUNT_PLACEHOLDER/$ARTICLE_COUNT/g" /tmp/pr-body.md
          sed -i "s/DISCOVERED_COUNT_PLACEHOLDER/$DISCOVERED_COUNT/g" /tmp/pr-body.md
          sed -i "s/DATE_PLACEHOLDER/$DATE/g" /tmp/pr-body.md
          sed -i "s/DIGEST_TITLE_PLACEHOLDER/$DIGEST_TITLE/g" /tmp/pr-body.md
          sed -i "s|DIGEST_FILE_PLACEHOLDER|$DIGEST_FILE|g" /tmp/pr-body.md

          # Create PR using the body file
          gh pr create \
            --title "ðŸ¤– Weekly Digest & Discoveries - $WEEK_RANGE" \
            --label "automation,digest,review-needed" \
            --body-file /tmp/pr-body.md

      # Step 8: Handle workflow failures
      - name: Report automation failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "âš ï¸ Weekly Automation Failed - $(date +%Y-%m-%d)" \
            --label "automation,bug,urgent" \
            --body "## âš ï¸ Automation Workflow Failed

**Date**: $(date +'%B %d, %Y at %H:%M UTC')
**Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Failed Steps
Check the workflow logs above to identify which step failed.

### Common Issues
1. **API Key**: Verify \`ANTHROPIC_API_KEY\` secret is set correctly
2. **Rate Limits**: Check if API rate limits were exceeded
3. **Data Format**: Verify input data files are valid JSON
4. **Network**: Check if external sources (RSS/arXiv) are accessible

### Manual Recovery
If automation fails, you can run scripts manually:
\`\`\`bash
npm run fetch-articles
ANTHROPIC_API_KEY=your_key npm run extract-robots
ANTHROPIC_API_KEY=your_key npm run generate-digest
npm run update-analytics
\`\`\`

---
*Generated by Weekly Robot Discovery & Digest Automation*"
