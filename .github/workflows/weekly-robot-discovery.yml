name: Weekly Robot Discovery

on:
  schedule:
    - cron: '0 9 * * 5'  # Friday 9 AM UTC
  workflow_dispatch:  # Allow manual trigger
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug

jobs:
  discover-robots:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Step 1: Collect articles from RSS/arXiv (no API calls)
      - name: Collect articles from RSS/arXiv
        run: npm run fetch-articles

      # Step 2: Extract robots using Anthropic API
      - name: Extract robot data from articles
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npm run extract-robots

      # Step 3: Create feature branch for discoveries
      - name: Create discovery branch
        id: create_branch
        run: |
          BRANCH_NAME="discovery/weekly-robots-$(date +%Y-%m-%d)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"

      # Step 4: Commit discovery results
      - name: Commit discovery results
        run: |
          git add data/collected-articles/
          git add data/discovered-robots/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            DATE=$(date +%Y-%m-%d)
            ARTICLE_FILE="data/collected-articles/$DATE.json"
            ROBOT_FILE="data/discovered-robots/$DATE.json"

            ARTICLE_COUNT=$(jq -r '.total_count // 0' "$ARTICLE_FILE" 2>/dev/null || echo "0")
            DISCOVERED_COUNT=$(jq -r '.summary.total_discovered // 0' "$ROBOT_FILE" 2>/dev/null || echo "0")
            WEEK_RANGE=$(jq -r '.week_range // "this week"' "$ARTICLE_FILE" 2>/dev/null || echo "this week")

            git commit -m "feat: Weekly robot discovery for $(date +%b' '%d', '%Y)

            - Collected $ARTICLE_COUNT articles from robotics sources
            - Discovered $DISCOVERED_COUNT new robots
            - Week range: $WEEK_RANGE

            Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push -u origin "${{ steps.create_branch.outputs.branch_name }}"
            echo "has_changes=true" >> $GITHUB_ENV
          fi

      # Step 5: Create Pull Request for review
      - name: Create Pull Request
        if: env.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y-%m-%d)
          WEEK_RANGE=$(jq -r '.week_range // "this week"' "data/collected-articles/$DATE.json" 2>/dev/null || echo "this week")
          ARTICLE_COUNT=$(jq -r '.total_count // 0' "data/collected-articles/$DATE.json" 2>/dev/null || echo "0")
          DISCOVERED_COUNT=$(jq -r '.summary.total_discovered // 0' "data/discovered-robots/$DATE.json" 2>/dev/null || echo "0")

          # Get quality breakdown
          HIGH_QUALITY=$(jq -r '.summary.quality_breakdown.high // 0' "data/discovered-robots/$DATE.json" 2>/dev/null || echo "0")
          MEDIUM_QUALITY=$(jq -r '.summary.quality_breakdown.medium // 0' "data/discovered-robots/$DATE.json" 2>/dev/null || echo "0")
          LOW_QUALITY=$(jq -r '.summary.quality_breakdown.low // 0' "data/discovered-robots/$DATE.json" 2>/dev/null || echo "0")

          # Validate and escape variables for sed
          if [ -z "$WEEK_RANGE" ]; then
            WEEK_RANGE="this week"
          fi
          WEEK_RANGE_ESCAPED=$(printf '%s\n' "$WEEK_RANGE" | sed 's/[&/\]/\\&/g')
          GENERATED_DATE=$(date +'%B %d, %Y at %H:%M UTC')
          GENERATED_DATE_ESCAPED=$(printf '%s\n' "$GENERATED_DATE" | sed 's/[&/\]/\\&/g')

          # Create PR body from template
          cat > /tmp/pr-body.md <<'TEMPLATE'
## ðŸ¤– Weekly Robot Discovery

**Week**: WEEK_RANGE_PLACEHOLDER
**Generated**: GENERATED_DATE_PLACEHOLDER

### ðŸ“° Article Collection
- **Total Articles Collected**: ARTICLE_COUNT_PLACEHOLDER from IEEE TV, Robot Report, arXiv
- **Source File**: `data/collected-articles/DATE_PLACEHOLDER.json`

### ðŸ” Robot Discovery
- **New Robots Discovered**: DISCOVERED_COUNT_PLACEHOLDER
- **Quality Breakdown**:
  - ðŸŒŸ High Quality: HIGH_QUALITY_PLACEHOLDER
  - â­ Medium Quality: MEDIUM_QUALITY_PLACEHOLDER
  - â˜ï¸ Low Quality: LOW_QUALITY_PLACEHOLDER
- **Discovery File**: `data/discovered-robots/DATE_PLACEHOLDER.json`

---

### âœ… Next Steps

1. **Review discovered robots** in `data/discovered-robots/DATE_PLACEHOLDER.json`
2. **Research official specifications** from manufacturer websites
3. **Download images locally** to `public/images/robots/[brand]-[model]/`
4. **Add to catalog** using Claude Code:
   ```
   Add the new robots from @data/discovered-robots/DATE_PLACEHOLDER.json
   Note: all images must be downloaded locally, follow @src/components/RobotDetailTemplate.tsx
   ```
5. **Merge this PR** to save the discovery data

### ðŸ“Š Weekly Discovery Data

This PR contains the raw discovery data from automated article collection and AI-powered robot extraction. The discovered robots are candidates for addition to the main catalog after manual review and enrichment.

**Files Added:**
- `data/collected-articles/DATE_PLACEHOLDER.json` - Raw articles from robotics sources
- `data/discovered-robots/DATE_PLACEHOLDER.json` - Extracted robot data with quality scores

---

### ðŸ”§ Troubleshooting

If the discovery process failed or produced unexpected results:

1. **Check article sources**: Verify RSS feeds and arXiv API are accessible
2. **Review API logs**: Check if ANTHROPIC_API_KEY is configured correctly
3. **Validate JSON**: Ensure output files are valid JSON format
4. **Manual run**: Execute locally with:
   ```bash
   npm run fetch-articles
   ANTHROPIC_API_KEY=your_key npm run extract-robots
   ```

See `docs/GITHUB-ACTIONS-PLACEHOLDERS.md` for detailed troubleshooting guide.

---

*Generated by Weekly Robot Discovery workflow*
TEMPLATE

          # Substitute placeholders with actual values using escaped variables
          sed -i "s/WEEK_RANGE_PLACEHOLDER/$WEEK_RANGE_ESCAPED/g" /tmp/pr-body.md
          sed -i "s/GENERATED_DATE_PLACEHOLDER/$GENERATED_DATE_ESCAPED/g" /tmp/pr-body.md
          sed -i "s/ARTICLE_COUNT_PLACEHOLDER/$ARTICLE_COUNT/g" /tmp/pr-body.md
          sed -i "s/DISCOVERED_COUNT_PLACEHOLDER/$DISCOVERED_COUNT/g" /tmp/pr-body.md
          sed -i "s/HIGH_QUALITY_PLACEHOLDER/$HIGH_QUALITY/g" /tmp/pr-body.md
          sed -i "s/MEDIUM_QUALITY_PLACEHOLDER/$MEDIUM_QUALITY/g" /tmp/pr-body.md
          sed -i "s/LOW_QUALITY_PLACEHOLDER/$LOW_QUALITY/g" /tmp/pr-body.md
          sed -i "s/DATE_PLACEHOLDER/$DATE/g" /tmp/pr-body.md

          # Create PR using the body file
          gh pr create \
            --title "ðŸ¤– Weekly Robot Discovery - $WEEK_RANGE" \
            --label "automation,discovery,review-needed" \
            --body-file /tmp/pr-body.md

      # Step 6: Report failures
      - name: Report discovery failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "âš ï¸ Weekly Robot Discovery Failed - $(date +%Y-%m-%d)" \
            --label "automation,bug,urgent" \
            --body "## âš ï¸ Robot Discovery Workflow Failed

**Date**: $(date +'%B %d, %Y at %H:%M UTC')
**Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Failed Steps
Check the workflow logs above to identify which step failed.

### Common Issues

1. **Article Collection Failed**
   - Check RSS feed availability (IEEE TV, Robot Report)
   - Verify arXiv API accessibility
   - Review network connectivity

2. **Robot Extraction Failed**
   - Verify \`ANTHROPIC_API_KEY\` secret is set correctly
   - Check API rate limits
   - Validate article data format

3. **Data Format Issues**
   - Ensure collected articles JSON is valid
   - Check for malformed article content
   - Verify extraction output format

### Manual Recovery

Run the discovery process manually:

\`\`\`bash
# Collect articles
npm run fetch-articles

# Extract robots (requires API key)
ANTHROPIC_API_KEY=your_key npm run extract-robots

# Review output files
cat data/collected-articles/$(date +%Y-%m-%d).json
cat data/discovered-robots/$(date +%Y-%m-%d).json
\`\`\`

### Additional Resources

- Discovery documentation: \`docs/CLAUDE.md\` (Weekly Robot Discovery System)
- Troubleshooting guide: \`docs/GITHUB-ACTIONS-PLACEHOLDERS.md\`
- Manual processing: Use Claude Code Pro to process discoveries

---
*Generated by Weekly Robot Discovery workflow*"
