name: Weekly Awesome Robots Digest

on:
  schedule:
    # Every Friday at 10:00 AM UTC+11 (which is 23:00 UTC Thursday)
    - cron: '0 23 * * 4'
  workflow_dispatch:
    inputs:
      publish_immediately:
        description: 'Publish to dev.to immediately as draft'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-digest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Generate digest template
      run: npm run generate-digest
    
    - name: Commit and push new digest
      run: |
        git add content/blog/awesome-robots-digest-issue-*.md
        if git diff --staged --quiet; then
          echo "No new digest files to commit"
        else
          git commit -m "Generate Awesome Robots Digest template for $(date '+%Y-%m-%d')
          
          ğŸ¤– Auto-generated weekly digest template
          
          Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push
        fi
    
    - name: Publish to dev.to (if requested)
      if: ${{ github.event.inputs.publish_immediately == 'true' }}
      env:
        DEV_TO_API_KEY: ${{ secrets.DEV_TO_API_KEY }}
        NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
      run: |
        # Find the latest digest file
        LATEST_DIGEST=$(ls -t content/blog/awesome-robots-digest-issue-*.md | head -n 1)
        echo "Publishing: $LATEST_DIGEST"
        npm run publish-blog file "$LATEST_DIGEST" -- --draft
    
    - name: Create PR for manual review (scheduled runs)
      if: ${{ github.event_name == 'schedule' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create a branch for the digest
        BRANCH_NAME="digest/$(date '+%Y-%m-%d')"
        git checkout -b "$BRANCH_NAME"
        git push -u origin "$BRANCH_NAME"
        
        # Create PR
        gh pr create \
          --title "ğŸ“° Weekly Digest - $(date '+%B %d, %Y')" \
          --body "## ğŸ¤– Automated Weekly Digest Template
        
        This PR contains the automatically generated template for this week's Awesome Robots Digest.
        
        ### Next Steps:
        1. ğŸ“ **Review and edit** the digest content
        2. ğŸ” **Add this week's news**, research, and developments  
        3. ğŸ¯ **Fill in the TL;DR** section with key highlights
        4. âœ… **Merge** when ready to publish
        5. ğŸš€ **Run** \`npm run publish-blog file content/blog/awesome-robots-digest-issue-X.md\` to publish to dev.to
        
        ### Template Sections Created:
        - ğŸ“‹ TL;DR (needs content)
        - ğŸš€ Introduction (needs content)
        - ğŸ“° Top News & Breakthroughs (placeholder structure)
        - ğŸ”¬ Research Spotlight (placeholder structure)
        - ğŸ“… Event Horizon (placeholder structure)
        - ğŸ› ï¸ Tool/Resource of the Week (placeholder structure)
        - ğŸ‘¥ Community Corner (placeholder structure)
        - ğŸ¯ Trends to Watch (placeholder structure)
        - ğŸ¯ Conclusion (placeholder structure)
        
        ### Publishing Commands:
        \`\`\`bash
        # Publish to dev.to only
        npm run publish-blog file content/blog/awesome-robots-digest-issue-X.md
        
        # Generate and publish as draft immediately  
        npm run digest-and-publish
        \`\`\`
        
        ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" \
          --assignee "${{ github.actor }}"